<analysis>**original_problem_statement:**
The user's initial goal was to build a super app. The project has evolved to include an e-commerce store (), a textbook access request system for parents, a ping-pong club management module (), and more.

The previous session focused on building the textbook access request flow and a dynamic form management system for admins. However, the agent repeatedly introduced Spanish variable names, violating a core project requirement.

This session's primary goals, driven by user feedback, were:
1.  **Refactor to English:** Complete the refactoring of all Spanish-named variables, functions, and comments to English.
2.  **Fix Data Inconsistencies:** Resolve bugs where data updated by an admin (like available schools or student approval status) was not reflected for the user.
3.  **Major Architecture Refactoring:** Address user confusion about the project structure by reorganizing frontend folders and renaming database collections for clarity and consistency, following an English-first and module-based approach.
4.  **Enable Production Migration:** Create a mechanism for the user to apply these database schema changes to their production environment.

**User's preferred language**: Spanish

**what currently exists?**
The application is a full-stack system with a React frontend, FastAPI backend, and MongoDB. A major architectural refactoring has been completed.

-   **Frontend**: The module structure has been reorganized for clarity. Admin-related UIs are now in , and user-facing account pages are in . Legacy folders (, ) have been deleted.
-   **Backend**: Database collections have been renamed to be consistent and prefixed by module (e.g.,  is now ). The services and repositories have been updated to use these new collection names.
-   **Migration Tool**: A temporary Migración BD tab with a button has been added to the admin panel. This allows the user to safely execute a script that renames the collections in the production database to match the new code, preventing data loss.
-   **Documentation**: The project structure and coding standards are now documented in . The  has been cleaned and split into  (core requirements),  (history), and  (backlog).

**Last working item**:
-   **Last item agent was working:** The user reported an error (body stream already read) when clicking the newly created Execute Migration button in the admin panel. The agent identified and fixed issues in both the frontend component () and the backend API endpoint ().
-   **Status:** USER VERIFICATION PENDING
-   **Agent Testing Done:** Y
-   **Which testing method agent to use?** Manual testing by the user after deployment. The user needs to:
    1.  Deploy the latest changes to production.
    2.  Log in as admin ().
    3.  Navigate to Admin -> Administración -> Migración BD.
    4.  Click the Ejecutar Migración button and confirm it succeeds.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Production Database Migration (P0)**
    -   **Description**: The production database has an old schema (e.g., collection named ), while the newly deployed code expects a new schema (). This breaks functionality in production. The user must use the new Migrate Database button in the admin UI to align the production DB with the code.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** N
-   **Issue 2: Admin Sidebar Modules Disappear (P1)**
    -   **Description**: A recurring critical bug where the admin sidebar modules vanish after login, blocking all admin functions. Its intermittent nature requires careful monitoring.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
-   **Issue 3: Google Sign-Up Flow is Broken (P2)**
    -   **Description**: The Continue with Google feature is stuck in an infinite loop. The agent confirmed the user  likely uses Google Auth but doesn't exist in the preview DB.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
-   **Issue 4: Legacy Toast Error Error al cargar matrículas (P3)**
    -   **Description**: A non-critical toast error related to a deprecated system still appears in the admin panel.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
-   **Issue 5: Persistent Development Script Error (P3)**
    -   **Description**: A recurring runtime error from an external script () overlays the UI.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P0: Remove Migration Tool:** After the production migration is confirmed successful, the temporary UI () and API endpoint () must be removed for security.
    -   **P1:** Implement OneSignal push notifications for textbook access request status changes.
    -   **P2:** Implement a feature to mark books as Already Ordered.
    -   **P3:** Integrate Stripe for payment processing of memberships.
-   **Future Tasks:**
    -   Integrate Google Sheets API for direct data import.
    -   Create a selector for pre-designed templates for landing page blocks.
    -   Implement a system for handling textbook re-purchase requests.
    -   Integrate ChipiPoints as a payment method.
    -   Develop a system of teams/clans with collective rewards.
    -   Add email notifications for critical role assignments.

**Completed work in this session**
-   **Major Architecture Refactoring:**
    -   **Frontend:** Reorganized modules into  and , deleting legacy  and  folders.
    -   **Backend:** Standardized database collection names (e.g.,  -> ).
    -   **DB Migration:** Created and deployed a safe, UI-triggered migration tool for the user to run in production.
-   **Data Consistency & Bug Fixes:**
    -   Fixed a bug where student  and  were not updating on the frontend by flattening the API response.
    -   Centralized school management into a new dedicated Escuelas admin tab to resolve inconsistencies.
    -   Fixed a critical submission bug caused by an invalid fallback .
-   **Code Quality & Documentation:**
    -   Completed the full English refactoring of .
    -   Created  to document the new structure.
    -   Refactored the monolithic  into , , and  and updated the core problem statement to be accurate.
-   **Feature Enhancement:**
    -   Added an auto-scroll feature to the Add Another Student form.

**Earlier issues found/mentioned but not fixed**
-   None that aren't already listed in the Pending Issues section.

**Known issue recurrence from previous fork**
-   The Admin Sidebar Disappears, Google Sign-Up, and emergent-main.js errors are all recurring issues from the previous fork that were not addressed in this session.

**Code Architecture**


**Key Technical Concepts**
-   **Database Migration:** A pattern was implemented to manage breaking schema changes in a live production environment. A Python script handles the logic, and a temporary, admin-protected API endpoint allows the user to trigger it safely from the UI.
-   **Code Refactoring & Restructuring:** The frontend directory structure was significantly refactored for clarity and scalability, moving from a confusing / split to a more intuitive / structure.
-   **Data Source Unification:** Resolved data inconsistencies by centralizing the management of schools into a single source of truth (a dedicated collection and admin UI), removing a conflicting data source from the dynamic form configuration.
-   **Data Flattening:** Backend services were modified to flatten nested data structures () in API responses. This simplified frontend logic and fixed bugs where the UI was not displaying the latest data.

**key DB schema**
-   **DB Name:** 
-   ****: Main user identity collection.
-   **** (was ): Extended user data.
-   **** (was ): Manages school data.
-   **** (was ): Manages student linking requests and enrollments.
-   **** (was ): Dynamic form configurations.
-   **Deprecated collections to be migrated in prod:** , , , , .

**changes in tech stack**
-   None.

**All files of reference**
-   **/app/frontend/src/modules/admin/DatabaseMigrationModule.jsx**: **(Highest Importance)** The new UI component for the user to trigger the production DB migration.
-   **/app/backend/scripts/migrate_collections_v2.py**: The Python script that performs the database migration.
-   **/app/backend/modules/admin/routes.py**: Contains the temporary  endpoint.
-   **/app/memory/ARCHITECTURE.md**: Documents the new, refactored project structure.
-   **/app/memory/PRD.md**: The cleaned-up, high-level product requirements.
-   **/app/memory/ROADMAP.md**: The prioritized feature backlog.

**Areas that need refactoring**:
-   The database migration feature ( and its API endpoint) is temporary and should be removed after it has been successfully used in production.
-   The legacy toast error Error al cargar matrículas points to old code in the  that should be cleaned up or removed.

**key api endpoints**
-   : **(NEW & Temporary)** Executes the database collection migration. Must be called by an authenticated admin.
-   : **(NEW)** Fetches all student records from all users for the central admin table.
-   : **(NEW/UPDATED)** Full CRUD endpoints for managing schools from the new admin UI.

**Critical Info for New Agent**
-   **User Language**: **Spanish**. All communication must be in Spanish.
-   **PRODUCTION MIGRATION IS REQUIRED**: The application is currently **broken in production**. The code has been updated to use new database collection names (e.g., ), but the production database still uses the old names (e.g., ). Your top priority is to guide the user to deploy the latest changes and then use the new Migración BD button in the admin panel to run the migration script. The app will not function correctly until this is done.
-   **New Architecture**: The project has undergone a significant refactoring. Refer to  for the new standard folder (, ) and DB collection naming conventions. Do not use the old structures.
-   **New Documentation**: The PRD has been split for clarity. Use  for core requirements,  for the backlog, and  for history.

**documents and test reports created in this job**
-   
-    (Overwritten/Cleaned)
-   
-   
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: Asks if deploying with a new database will also clean up old code files.
2.  **User**: After being told no, confirms they want old/unused code folders deleted for a clean project.
3.  **User**: Asks to ensure guideline documents are in place for future development.
4.  **User**: Asks for clarification on the Problem Statement in the PRD.
5.  **User**: Confirms the agent's proposed Problem Statement is more accurate but notes that  module is missing and asks for verification.
6.  **User**: Agrees with the new, comprehensive problem statement that includes all discovered modules.
7.  **User**: After deploying, reports that the new database option wasn't available and observes mixed behavior (admin login works, but school data is missing), indicating an old DB.
8.  **User**: Agrees to run the migration script in production to fix the inconsistency.
9.  **User**: Agrees to the agent's proposal to create a button in the admin UI to trigger the migration.
10. **User**: Reports an error (body stream already read) after using the migration button, which is the last issue the agent worked on.

**Project Health Check:**
-   **Broken**:
    -   **Production Environment**: The app is functionally broken in production due to the mismatch between the deployed code's expectations and the database's current schema. This is the top priority to fix via migration.
    -   Google Authentication flow.
-   **Needs Refactoring**:
    -   The temporary database migration feature (UI and API endpoint) must be removed after successful use.
    -   A legacy toast error points to code that should be cleaned up.
-   **Mocked**:
    -   OneSignal (Push Notifications).

**3rd Party Integrations**
-   **OneSignal**: Push Notifications (planned).
-   **Monday.com**: Order/chat syncing.
-   **i18next**: Multi-language support.
-   **ipapi.co**: IP-based geolocation.
-   **Yappy Comercial (BG)**: Payment gateway.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: None.
-   **Known regressions**: None in this session; the agent fixed previous regressions.

**Credentials to test flow:**
-   **Super Admin Email**: 
-   **Super Admin Password**: 
-   **Regular User Email (Production ONLY)**:  | Password: 
-   **Regular User Email (Preview ONLY)**:  | Password: 

**What agent forgot to execute**
-   The agent did not delete the legacy file  after copying its contents to the new location (). This file is now redundant and should be removed.
-   The long-standing issues with Google Sign-Up, the  script error, and the disappearing admin sidebar were not addressed as the focus was on the major refactoring and migration tasks requested by the user.</analysis>
